terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = ">= 5.0"
    }
    kubernetes = {
      source  = "hashicorp/kubernetes"
      version = ">= 2.29"
    }
    helm = {
      source  = "hashicorp/helm"
      version = ">= 3.1"
    }
  }
  required_version = ">= 1.5.0"
}

provider "aws" {
  region = "${region}"
}

################################################################################
# Kubernetes and Helm Providers
################################################################################

data "aws_eks_cluster_auth" "this" {
  name = "${cluster_name}"
}

provider "kubernetes" {
  host                   = "${cluster_endpoint}"
  cluster_ca_certificate = base64decode("${cluster_ca_data}")
  token                  = data.aws_eks_cluster_auth.this.token
}

provider "helm" {
  kubernetes = {
    host                   = "${cluster_endpoint}"
    cluster_ca_certificate = base64decode("${cluster_ca_data}")
    token                  = data.aws_eks_cluster_auth.this.token
  }
}

################################################################################
# Quix EKS Dependencies Module
################################################################################

module "quix_eks_dependencies" {
  source = "github.com/quixio/terraform-quixplatform-aws//modules/quix-eks-dependencies?ref=main"

  cluster_name            = "${cluster_name}"
  region                  = "${region}"
  amazon_container_id     = "${amazon_container_id}"
  oidc_provider_arn       = "${oidc_provider_arn}"
  cluster_oidc_issuer_url = "${cluster_oidc_issuer_url}"

  enable_calico = true

  enable_aws_load_balancer_controller = true
  nlb_controller_namespace            = "kube-system"
  nlb_controller_service_account      = "aws-load-balancer-controller"

  enable_efs_csi_addon    = true
  efs_csi_namespace       = "kube-system"
  efs_csi_service_account = "efs-csi-controller-sa"

  create_efs_storage_class         = true
  efs_storage_class_name           = "efs-sc"
  efs_storage_class_reclaim_policy = "Retain"
  efs_file_system_id               = "${efs_file_system_id}"

  create_ebs_storage_class                 = true
  ebs_storage_class_name                   = "gp3"
  ebs_storage_class_is_default             = true
  ebs_storage_class_reclaim_policy         = "Delete"
  ebs_storage_class_volume_binding_mode    = "WaitForFirstConsumer"
  ebs_storage_class_allow_volume_expansion = true
  ebs_volume_type                          = "gp3"

  tags = ${tags_json}
}